<figure>
    {% if link %}
    <a href="{{ link }}">
        {% endif %}

        {# The decoder for WebP does not support the format features ALPH #}
        {% set meta_path = page.path~src %}
        {% if not meta_path is ending_with(".webp") %}
            {% set meta = get_image_metadata(path=meta_path) %}
        {% endif %}
        <img src="{{ src }}" 
        loading="lazy"
        {% if alt %}
            alt="{{ alt }}"
        {% elif caption %}
            alt="{{ caption | markdown(inline=true) | safe }}"
        {% elif credits %}
            alt="{{ credits | markdown(inline=true) | safe }}"
        {% endif %}
        {% if width %}
            width="{{ width }}"
        {% elif meta.width %}
            width="{{ meta.width }}"
        {% endif %}
        {% if height %}
            height ="{{ height }}"
        {% elif meta.height %}
            height="{{ meta.height }}"
        {% endif %} 
        />

        {% if link %}
    </a>
    {% endif %}
    {% if caption or credits %}
    <figcaption>
        {% if caption %}
        {{ caption | markdown(inline=true) | safe }}
        {% endif %}
        {% if credits %}<br />
        {{ credits | markdown(inline=true)| safe }}
        {% endif %}
    </figcaption>
    {% endif %}
</figure>